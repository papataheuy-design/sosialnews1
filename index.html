<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pordisk â€” Portal Diskusi Berita</title>
<!-- Tailwind CSS CDN untuk styling modern dan responsif -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Google Fonts - Inter untuk tipografi yang bersih -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Minimal modern styling -->
<style>
Â  :root{
Â  Â  --bg:#f7f8fb; --card:#fff; --primary:#4361ee; --muted:#6b7280; --accent:#10b981;
Â  }
Â  *{box-sizing:border-box}
Â  body{font-family:'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#111}
Â  header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:linear-gradient(90deg,#e6ffef,#d1fbe6);border-bottom:1px solid #e6eef0}
Â  .brand{font-weight:700;font-size:20px;padding-left:8px}
Â  .user-area{display:flex;align-items:center;gap:10px}
Â  .avatar{width:36px;height:36px;border-radius:999px;background:#ddd;overflow:hidden;display:grid;place-items:center; flex-shrink: 0;}
Â  .avatar img{width:100%;height:100%;object-fit:cover}
Â  .btn{background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer; transition: background-color 0.2s ease;}
Â  .btn:hover{background-color: #364fc7;} /* Darker blue on hover */
Â  .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(67,97,238,0.12); transition: background-color 0.2s ease;}
Â  .btn.ghost:hover{background-color:rgba(67,97,238,0.05);}
Â  .btn.danger{background-color: #ef4444; color: #fff; border: none;} /* Red color for delete */
Â  .btn.danger:hover{background-color: #dc2626;}
Â  .container{max-width:980px;margin:18px auto;padding:0 16px}
Â  /* Banner / Slider */
Â  .banner{position:relative;height:420px;border-radius:14px;overflow:hidden;background:#eee;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
Â  .slide{position:absolute;inset:0;opacity:0;transition:opacity .8s ease, transform .5s ease;display:flex;align-items:flex-end}
Â  .slide.active{opacity:1; z-index: 1;} /* Make active slide on top */
Â  .slide .media{position:absolute;inset:0;background-size:cover;background-position:center;filter:brightness(.6)}
Â  .slide .overlay{position:relative;z-index:2;padding:28px;width:100%;color:#fff;display:flex;flex-direction:column;gap:12px}
Â  .title{font-size:28px;font-weight:800;line-height:1.03;letter-spacing:-0.5px}
Â  .excerpt{font-size:16px;color:rgba(255,255,255,.95);max-width:75%}
Â  .slide .actions{display:flex;gap:10px;align-items:center;margin-top:6px}
Â  .chip{background:rgba(255,255,255,.12);padding:8px 12px;border-radius:999px;display:inline-flex;align-items:center;gap:8px;color:#fff;border:1px solid rgba(255,255,255,.06); cursor:pointer; transition: background-color 0.2s ease;}
Â  .chip:hover{background-color:rgba(255,255,255,.2);}
Â  .slider-nav{position:absolute;inset:auto 12px 12px 12px;display:flex;justify-content:space-between;z-index:3;pointer-events:none; width: calc(100% - 24px);} /* full width for nav */
Â  .slider-nav button{pointer-events:auto;background:rgba(0,0,0,.45);border:none;color:#fff;padding:8px;border-radius:999px;cursor:pointer; transition: background-color 0.2s ease;}
Â  .slider-nav button:hover{background-color:rgba(0,0,0,.6);}
Â  .news-controls{display:flex;gap:10px;align-items:center}
Â  .news-controls button{background:rgba(255,255,255,.12);border:0;color:#fff;padding:8px 12px;border-radius:999px;cursor:pointer; transition: background-color 0.2s ease;}
Â  .news-controls button:hover{background-color:rgba(255,255,255,.2);}
Â  /* discussion area */
Â  .section{margin-top:18px}
Â  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(16,24,40,0.04)}
Â  .post-row{display:flex;gap:10px;align-items:flex-start}
Â  .post-row textarea{flex:1;border-radius:10px;padding:12px;border:1px solid #e6eef0;min-height:72px;resize:vertical;font-size:15px; outline:none; transition: border-color 0.2s ease;}
Â  .post-row textarea:focus{border-color:var(--primary);}
Â  .small{font-size:13px;color:var(--muted)}
Â  .tab{background:var(--card);border:1px solid #e6eef0;padding:8px 12px;border-radius:999px;cursor:pointer; transition: all 0.2s ease;}
Â  .tab.active{background:var(--primary);color:#fff;border-color:var(--primary);}
Â  .tab:hover:not(.active){background-color:#f0f4ff;}
Â  .list .item{padding:12px;border-radius:10px;background:#fff;margin-bottom:12px;box-shadow:0 3px 10px rgba(16,24,40,0.03); border:1px solid #eee;}
Â  .item .meta{display:flex;gap:10px;align-items:center}
Â  .item .meta .name{font-weight:700}
Â  .item .text{margin-top:8px;white-space:pre-wrap; word-break: break-word;} /* ensure long words break */
Â  .news-ref{font-size:14px;color:var(--primary);margin-top:8px;border-left:3px solid var(--primary);padding-left:10px;}
Â  .acts{display:flex;gap:10px;align-items:center;margin-top:10px}
Â  .acts button{background:transparent;border:1px solid #eee;padding:6px 10px;border-radius:999px;cursor:pointer;display:inline-flex;gap:8px;align-items:center; transition: background-color 0.2s ease;}
Â  .acts button:hover{background-color:#f5f5f5;}
Â  .reply-list{margin-top:10px;padding-left:42px; border-left: 2px dashed #e6eef0;}
Â  .reply{margin-top:8px;padding:8px;border-radius:8px;background:#f8fafc; border:1px solid #eef;}
Â  .load-more{display:block;margin:8px auto;background:transparent;border:1px dashed #dbeafe;padding:8px 12px;border-radius:8px;color:var(--primary);cursor:pointer; transition: background-color 0.2s ease;}
Â  .load-more:hover{background-color:#e0edff;}

Â  /* responsive */
Â  @media(max-width:720px){
Â  Â  .title{font-size:20px}
Â  Â  .excerpt{max-width:100%}
Â  Â  .banner{height:320px}
Â  Â  .reply-list{padding-left:15px;}
Â  Â  .user-area{gap:5px;}
    .post-row{flex-direction: column;}
    .post-row textarea{width: 100%;}
    .post-row > div:last-child { width: 100%; display: flex; gap: 8px;}
    .post-row > div:last-child select, .post-row > div:last-child button { flex: 1; }
Â  }
</style>
</head>
<body>
<header>
Â  <div style="display:flex;align-items:center;gap:12px;padding-left:18px">
Â  Â  <div class="brand">pordisk</div>
Â  </div>
Â  <div style="padding-right:18px">
Â  Â  <div class="user-area">
Â  Â  Â  <div class="avatar" id="headerAvatar"><span style="font-weight:700;color:#111">ğŸ‘¤</span></div>
Â  Â  Â  <div id="headerName" class="small">Memuat...</div>
Â  Â  Â  <button id="loginBtn" class="btn" style="margin-left:8px">Masuk</button>
Â  Â  Â  <button id="logoutBtn" class="btn ghost" style="display:none;margin-left:8px">Keluar</button>
Â  Â  </div>
Â  </div>
</header>

<div class="container">
Â  <!-- Banner / Slider Berita -->
Â  <div class="banner card" id="banner">
Â  Â  <!-- slides injected here by JavaScript -->
Â  Â  <div class="slider-nav">
Â  Â  Â  <button id="prevBtn" aria-label="previous news">â€¹</button>
Â  Â  Â  <button id="nextBtn" aria-label="next news">â€º</button>
Â  Â  </div>
Â  </div>

Â  <!-- Tabs dan Kontrol -->
Â  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:12px; flex-wrap: wrap;">
Â  Â  <div style="display:flex;gap:10px; flex-wrap: wrap;">
Â  Â  Â  <button class="tab active" id="tabAll">Semua</button>
Â  Â  Â  <button class="tab" id="tabNews">Diskusi Berita</button>
Â  Â  Â  <button class="tab" id="tabLocal">Diskusi Lokal</button>
Â  Â  </div>
Â  Â  <div class="news-controls">
Â  Â  Â  <button id="refreshNews" title="Update berita">Refresh Berita</button>
Â  Â  </div>
Â  </div>

Â  <!-- Form Posting Diskusi -->
Â  <div class="section">
Â  Â  <div class="card">
Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  Â  <div class="small">portal diskusi disisni</div>
Â  Â  Â  Â  <div class="small" id="postingAs"></div>
Â  Â  Â  </div>
Â  Â  Â  <div style="height:12px"></div>
Â  Â  Â  <div class="post-row">
Â  Â  Â  Â  <textarea id="postInput" placeholder="Mulai Berdiskusi..."></textarea>
Â  Â  Â  Â  <div style="display:flex;flex-direction:column;gap:8px">
Â  Â  Â  Â  Â  <select id="postType" style="padding:8px;border-radius:8px;border:1px solid #e6eef0; outline:none;">
Â  Â  Â  Â  Â  Â  <option value="news">Diskusi Berita</option>
Â  Â  Â  Â  Â  Â  <option value="local">Diskusi Lokal</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  <button id="postBtn" class="btn">Posting</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <!-- Daftar Diskusi -->
Â  <div class="section">
Â  Â  <h3 id="listTitle">Diskusi Terbaru</h3>
Â  Â  <div id="list" class="list card" style="padding:14px">
Â  Â  Â  <div class="small">Memuat diskusiâ€¦</div>
Â  Â  </div>
Â  Â  <button id="moreBtn" class="load-more" style="display:none">Muat lebih banyak</button>
Â  </div>
</div>

<!-- Firebase SDKs (using compat versions as per original code) -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
/* ================= Firebase config (menggunakan konfigurasi yang Anda berikan) ================= */
// Menginisialisasi Firebase dengan konfigurasi Anda
const firebaseConfig = {
Â  apiKey: "AIzaSyAN825UwYIJ6zGgOpb8fYWZBeBfOSvNNU4",
Â  authDomain: "socialnewshariini.firebaseapp.com",
Â  projectId: "socialnewshariini",
Â  storageBucket: "socialnewshariini.firebasestorage.app",
Â  messagingSenderId: "579951188459",
Â  appId: "1:579951188459:web:83322616a6bfd971eea1ae",
Â  measurementId: "G-7KSKKSPFH4"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= State Aplikasi ================= */
let me = null; // Objek pengguna Firebase yang sedang login
let newsItems = [];Â  Â  // Daftar berita yang dimuat dari RSS
let slideIndex = 0; // Indeks berita yang sedang ditampilkan di slider
let slideTimer = null; // Timer untuk slide otomatis
const slideIntervalMs = 8000; // Durasi slide otomatis (8 detik)
const rssSources = [ // Sumber RSS untuk berita
Â  { name: 'Detik', url: 'https://rss.detik.com/index.php/detikcom' },
Â  { name: 'Tribun', url: 'https://www.tribunnews.com/rss' },
Â  { name: 'CNN Indonesia', url: 'https://www.cnnindonesia.com/rss' },
Â  { name: 'Kompas', url: 'https://www.kompas.com/news/rss' } // Menambahkan Kompas
];
const newsCache = { data: null, t: 0, ttl: 10*60*1000 }; // Cache berita selama 10 menit

/* ================= Referensi Elemen DOM ================= */
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const headerAvatar = document.getElementById('headerAvatar');
const headerName = document.getElementById('headerName');
const postingAs = document.getElementById('postingAs');
const banner = document.getElementById('banner');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const refreshNews = document.getElementById('refreshNews');
const tabAll = document.getElementById('tabAll');
const tabNews = document.getElementById('tabNews');
const tabLocal = document.getElementById('tabLocal');
const postInput = document.getElementById('postInput');
const postType = document.getElementById('postType');
const postBtn = document.getElementById('postBtn');
const listEl = document.getElementById('list');
const moreBtn = document.getElementById('moreBtn');
const listTitle = document.getElementById('listTitle');


/* ================= Autentikasi Pengguna ================= */
loginBtn.addEventListener('click', async () => {
Â  const provider = new firebase.auth.GoogleAuthProvider();
Â  try {
Â  Â  await auth.signInWithPopup(provider);
Â  } catch(e){
Â  Â  console.error('Login failed', e);
Â  Â  // Menggunakan console.warn sebagai ganti alert
Â  Â  console.warn('Login gagal. Silakan coba lagi.');
Â  }
});

logoutBtn.addEventListener('click', async () => {
Â  await auth.signOut();
});

// Memantau perubahan status autentikasi pengguna
auth.onAuthStateChanged(user => {
Â  me = user;
Â  if (user) { // Pengguna login (baik anonim atau via Google)
Â  Â  if (user.isAnonymous) {
Â  Â  Â  headerAvatar.innerHTML = `<span style="font-weight:700;color:#111">ğŸ‘¤</span>`;
Â  Â  Â  headerName.textContent = 'Anonim';
Â  Â  Â  postingAs.textContent = '';
Â  Â  Â  loginBtn.style.display = 'inline-block';
Â  Â  Â  logoutBtn.style.display = 'none';
Â  Â  } else { // Pengguna login via Google
Â  Â  Â  headerAvatar.innerHTML = `<img src="${user.photoURL || ''}" alt="avatar">`;
Â  Â  Â  headerName.textContent = user.displayName || user.email;
Â  Â  Â  loginBtn.style.display = 'none';
Â  Â  Â  logoutBtn.style.display = 'inline-block';
Â  Â  Â  postingAs.textContent = 'Posting sebagai ' + (user.displayName || 'Pengguna');
Â  Â  }
Â  } else { // Pengguna logout
Â  Â  headerAvatar.innerHTML = `<span style="font-weight:700;color:#111">ğŸ‘¤</span>`;
Â  Â  headerName.textContent = 'Masuk';
Â  Â  loginBtn.style.display = 'inline-block';
Â  Â  logoutBtn.style.display = 'none';
Â  Â  postingAs.textContent = '';
    // Sign in anonymously if not already logged in
    auth.signInAnonymously().catch(e => console.error("Anonymous sign-in failed:", e));
Â  }
});

/* ================= Berita: Ambil & Render Slider ================= */

// Fungsi untuk menghilangkan duplikasi berita berdasarkan judul
function dedupeByTitle(arr) {
Â  const seen = new Set();
Â  const out = [];
Â  for(const a of arr){
Â  Â  const k = (a.title || '').trim().toLowerCase();
Â  Â  if(!seen.has(k)){ seen.add(k); out.push(a); }
Â  }
Â  return out;
}

// Fungsi untuk mengambil berita dari berbagai sumber RSS
async function fetchRssMultiple() {
Â  // Gunakan cache jika masih valid
Â  if (newsCache.data && Date.now() - newsCache.t < newsCache.ttl) return newsCache.data;
Â  try {
Â  Â  const promises = rssSources.map(s =>
Â  Â  Â  fetch('https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent(s.url))
Â  Â  Â  .then(r => r.json())
Â  Â  Â  .catch(e => { console.warn(`Gagal memuat RSS dari ${s.name}:`, e); return {items:[]}; }) // Tangani kesalahan fetch
Â  Â  );
Â  Â  const results = await Promise.allSettled(promises);
Â  Â  let items = [];
Â  Â  for (const r of results) {
Â  Â  Â  if (r.status === 'fulfilled' && r.value.items) {
Â  Â  Â  Â  for (const it of r.value.items) {
Â  Â  Â  Â  Â  const imageUrl = (it.enclosure && it.enclosure.link) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (it.thumbnail && it.thumbnail.length > 0 ? it.thumbnail[0] : null) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ((it.content && (it.content.match(/https?:\/\/\S+\.(jpg|png|jpeg|gif|webp)/i) || [])[0])) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'https://via.placeholder.com/1200x700?text=NEWS'; // Placeholder jika tidak ada gambar
Â  Â  Â  Â  Â  items.push({
Â  Â  Â  Â  Â  Â  id: it.guid || it.link || Math.random().toString(36).slice(2),
Â  Â  Â  Â  Â  Â  title: it.title || 'Tanpa Judul',
Â  Â  Â  Â  Â  Â  description: (it.description || it.content || '').replace(/<[^>]+>/g,'').trim().slice(0,250) + '...', // Hapus tag HTML
Â  Â  Â  Â  Â  Â  thumbnail: imageUrl,
Â  Â  Â  Â  Â  Â  link: it.link || '#',
Â  Â  Â  Â  Â  Â  pubDate: it.pubDate || (it.isoDate || new Date().toISOString())
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  Â  // Hilangkan duplikasi berdasarkan judul dan urutkan berdasarkan tanggal publikasi terbaru
Â  Â  items = dedupeByTitle(items);
Â  Â  items.sort((a,b) => new Date(b.pubDate) - new Date(a.pubDate));
Â  Â  // Cache dan batasi jumlah berita
Â  Â  const limited = items.slice(0, 15);
Â  Â  newsCache.data = limited; newsCache.t = Date.now();
Â  Â  return limited;
Â  } catch (e) {
Â  Â  console.error('Kesalahan saat mengambil RSS:', e);
Â  Â  return [];
Â  }
}

// Fungsi untuk memuat berita dan merender slider
async function loadNewsAndRender() {
Â  // Hapus slide yang ada
Â  banner.querySelectorAll('.slide').forEach(n => n.remove());
Â  // Tampilkan indikator loading sementara
Â  const loading = document.createElement('div');
Â  loading.className = 'slide active';
Â  loading.innerHTML = `<div class="media" style="background:#111"></div><div class="overlay"><div class="title">Memuat beritaâ€¦</div><div class="excerpt">Harap tunggu sebentar.</div></div>`;
Â  banner.appendChild(loading);

Â  newsItems = await fetchRssMultiple();
Â  if (!newsItems || newsItems.length === 0) {
Â  Â  loading.querySelector('.title').textContent = 'Tidak ada berita yang tersedia.';
Â  Â  loading.querySelector('.excerpt').textContent = 'Coba refresh nanti.';
Â  Â  return;
Â  }
Â  // Hapus indikator loading
Â  banner.querySelectorAll('.slide').forEach(n => n.remove());

Â  // Render setiap item berita sebagai slide
Â  newsItems.forEach((n,i) => {
Â  Â  const s = document.createElement('div');
Â  Â  s.className = 'slide' + (i===0 ? ' active' : '');
Â  Â  s.innerHTML = `
Â  Â  Â  <div class="media" style="background-image:url('${escapeHtml(n.thumbnail)}')"></div>
Â  Â  Â  <div class="overlay">
Â  Â  Â  Â  <div class="title">${escapeHtml(n.title)}</div>
Â  Â  Â  Â  <div class="excerpt">${escapeHtml(n.description)}</div>
Â  Â  Â  Â  <div class="actions">
Â  Â  Â  Â  Â  <a class="chip" href="${escapeHtml(n.link)}" target="_blank" rel="noopener"><span>ğŸ”—</span> Sumber</a>
Â  Â  Â  Â  Â  <button class="chip" onclick="prefillFromNews('${escapeHtml(n.id)}')">ğŸ’¬ Diskusi</button>
Â  Â  Â  Â  Â  <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
Â  Â  Â  Â  Â  Â  <button class="chip" onclick="toggleNewsLike('${escapeHtml(n.id)}')">ğŸ‘ <span class="nl-count">0</span></button>
Â  Â  Â  Â  Â  Â  <button class="chip" onclick="toggleNewsDislike('${escapeHtml(n.id)}')">ğŸ‘ <span class="nd-count">0</span></button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="height:8px"></div>
Â  Â  Â  Â  <div style="display:flex;gap:10px;align-items:center">
Â  Â  Â  Â  Â  <input id="news-comment-${escapeId(n.id)}" placeholder="beri tanggapan berita ini" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff; outline:none;" class="focus:ring-2 focus:ring-blue-500 focus:border-transparent">
Â  Â  Â  Â  Â  <button class="btn" onclick="postNewsComment('${escapeHtml(n.id)}')">Kirim</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  `;
Â  Â  banner.appendChild(s);

Â  Â  // Memuat jumlah like/dislike secara real-time untuk setiap berita
Â  Â  watchNewsLikeCounts(n.id, s);
Â  });

Â  resetSlideTimer(); // Mulai/reset timer slide otomatis
}

// Fungsi helper untuk mengamankan string dari HTML
function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
// Fungsi helper untuk membuat ID yang aman untuk elemen DOM
function escapeId(id){ return String(id).replace(/[^a-z0-9_\-]/gi,'_'); }

/* Kontrol Slider */
prevBtn.addEventListener('click', ()=>{ moveSlide(-1); resetSlideTimer(); });
nextBtn.addEventListener('click', ()=>{ moveSlide(1); resetSlideTimer(); });

// Fungsi untuk menggeser slide
function moveSlide(delta){
Â  const slides = Array.from(document.querySelectorAll('#banner .slide'));
Â  if (slides.length <= 1) return;
Â  slides[slideIndex].classList.remove('active');
Â  slideIndex = (slideIndex + delta + slides.length) % slides.length;
Â  slides[slideIndex].classList.add('active');
}
// Fungsi untuk mereset timer slide otomatis
function resetSlideTimer(){
Â  clearInterval(slideTimer);
Â  slideTimer = setInterval(()=> moveSlide(1), slideIntervalMs);
}

/* ================= Berita: Like / Dislike & Komentar ================= */

// Fungsi untuk mengubah status like berita
async function toggleNewsLike(newsId){
Â  if(!me){ console.warn('Silakan login dulu untuk memberi reaksi.'); return; }
Â  const docRef = db.collection('news_reactions').doc(`${newsId}_${me.uid}`); // Menggabungkan newsId dan uid
Â  const docSnap = await docRef.get();
Â  const currentReaction = docSnap.exists() ? docSnap.data().reaction : null;

Â  if (currentReaction === 'like') {
Â  Â  await docRef.delete(); // Batalkan like
Â  } else {
Â  Â  // Hapus dislike jika ada, lalu tambahkan like
Â  Â  await docRef.set({ newsId, uid: me.uid, reaction: 'like', ts: firebase.firestore.FieldValue.serverTimestamp() });
Â  }
}

// Fungsi untuk mengubah status dislike berita
async function toggleNewsDislike(newsId){
Â  if(!me){ console.warn('Silakan login dulu untuk memberi reaksi.'); return; }
Â  const docRef = db.collection('news_reactions').doc(`${newsId}_${me.uid}`); // Menggabungkan newsId dan uid
Â  const docSnap = await docRef.get();
Â  const currentReaction = docSnap.exists() ? docSnap.data().reaction : null;

Â  if (currentReaction === 'dislike') {
Â  Â  await docRef.delete(); // Batalkan dislike
Â  } else {
Â  Â  // Hapus like jika ada, lalu tambahkan dislike
Â  Â  await docRef.set({ newsId, uid: me.uid, reaction: 'dislike', ts: firebase.firestore.FieldValue.serverTimestamp() });
Â  }
}

// Memantau jumlah like/dislike berita secara real-time
function watchNewsLikeCounts(newsId, slideEl){
Â  // Like counts
Â  db.collection('news_reactions').where('newsId','==',newsId).where('reaction','==','like').onSnapshot(snap=>{
Â  Â  const c = snap.size;
Â  Â  const span = slideEl.querySelector('.nl-count');
Â  Â  if(span) span.textContent = c;
Â  });
Â  // Dislike counts
Â  db.collection('news_reactions').where('newsId','==',newsId).where('reaction','==','dislike').onSnapshot(snap=>{
Â  Â  const c = snap.size;
Â  Â  const span = slideEl.querySelector('.nd-count');
Â  Â  if(span) span.textContent = c;
Â  });
}

// Fungsi untuk memposting komentar berita
async function postNewsComment(newsId){
Â  if(!me){ console.warn('Silakan login dulu untuk berkomentar.'); return; }
Â  const inputId = `news-comment-${escapeId(newsId)}`;
Â  const input = document.getElementById(inputId);
Â  if(!input) return;
Â  const text = input.value.trim();
Â  if(!text) return;

Â  // Menambahkan komentar ke koleksi news_comments
Â  await db.collection('news_comments').add({
Â  Â  newsId, text, name: me.displayName||'Anonim', photo: me.photoURL||'', uid: me.uid,
Â  Â  ts: firebase.firestore.FieldValue.serverTimestamp()
Â  });
Â  input.value = '';

Â  // Membuat entri posting forum yang mereferensikan komentar berita ini
Â  const newsTitle = newsItems.find(n => n.id === newsId)?.title || null;
Â  await db.collection('forum_posts').add({
Â  Â  type:'news', newsId, newsTitle: newsTitle,
Â  Â  text, name: me.displayName||'Anonim', photo: me.photoURL||'', uid: me.uid,
Â  Â  likes: [], time: firebase.firestore.FieldValue.serverTimestamp()
Â  });
Â  console.log('Komentar berita diposting dan ditambahkan ke forum.');
Â  // Listener forum akan otomatis memperbarui tampilan
}

/* ================= Forum (posts, replies, pagination, filter) ================= */
let lastVisible = null; // Dokumen terakhir yang terlihat untuk paginasi
let loadingForum = false; // Status loading forum
let currentFilter = 'all'; // Filter aktif saat ini ('all', 'news', 'local')

function showLoadingInList(){ listEl.innerHTML = '<div class="small">Memuat diskusiâ€¦</div>'; }
function showEmptyList(){ listEl.innerHTML = '<div class="small">Belum ada diskusi</div>'; }

// Fungsi untuk memuat postingan forum secara bertahap (paginasi)
async function loadForumMore(){
Â  if(loadingForum) return;
Â  loadingForum = true;
Â  moreBtn.textContent = 'Memuat...';
Â  try{
Â  Â  let q = db.collection('forum_posts').orderBy('time','desc').limit(12);
Â  Â  if(currentFilter === 'news') q = q.where('type','==','news');
Â  Â  if(currentFilter === 'local') q = q.where('type','==','local');
Â  Â  if(lastVisible) q = q.startAfter(lastVisible);

Â  Â  const snap = await q.get();
Â  Â  if(snap.empty && !lastVisible){ showEmptyList(); }
Â  Â  snap.docs.forEach(doc => renderForumItem(doc));

Â  Â  if(snap.docs.length >= 12){ // Jika ada kemungkinan ada lebih banyak data
Â  Â  Â  lastVisible = snap.docs[snap.docs.length-1];
Â  Â  Â  moreBtn.style.display = 'block';
Â  Â  Â  moreBtn.textContent = 'Muat lebih banyak';
Â  Â  } else {
Â  Â  Â  lastVisible = null;
Â  Â  Â  moreBtn.style.display='none'; // Sembunyikan tombol jika tidak ada lagi data
Â  Â  }
Â  }catch(e){
Â  Â  console.error('Gagal memuat forum:', e);
Â  Â  if(!lastVisible) listEl.innerHTML = '<div class="small">Gagal memuat diskusi</div>';
Â  Â  moreBtn.textContent = 'Gagal memuat, coba lagi.';
Â  } finally { loadingForum = false; }
}

// Render satu item postingan forum
function renderForumItem(doc){
Â  const v = doc.data();
Â  const id = doc.id;
Â  const item = document.createElement('div');
Â  item.className = 'item';
Â  item.dataset.id = id; // Tambahkan data-id untuk memudahkan identifikasi

Â  const canDelete = me && me.uid === v.uid; // Hanya penulis yang bisa menghapus
Â  const liked = Array.isArray(v.likes) && me && v.likes.includes(me.uid); // Cek apakah pengguna sudah like

Â  item.innerHTML = `
Â  Â  <div class="meta">
Â  Â  Â  <div style="display:flex;gap:10px;align-items:center">
Â  Â  Â  Â  <div class="avatar">${v.photo? `<img src="${escapeHtml(v.photo)}">` : `<span>${escapeHtml(v.name||'ğŸ‘¤').charAt(0).toUpperCase()}</span>`}</div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div class="name">${escapeHtml(v.name||'Pengguna Anonim')}</div>
Â  Â  Â  Â  Â  <div class="small">${fmt(v.time?.toDate?.() || v.time)}</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="text">${escapeHtml(v.text)}</div>
Â  Â  ${v.type === 'news' && v.newsTitle ? `<div class="news-ref"><strong>Diskusi Berita:</strong> <a href="#" onclick="prefillFromNews('${escapeId(v.newsId)}')">${escapeHtml(v.newsTitle)}</a></div>` : ''}
Â  Â  <div class="acts">
Â  Â  Â  <button onclick="toggleForumLike('${id}')">ğŸ‘ <span id="f-lk-${id}">${(v.likes||[]).length}</span></button>
Â  Â  Â  <button onclick="openReplies('${id}')">ğŸ’¬ Balasan</button>
Â  Â  Â  ${canDelete ? `<button onclick="deleteForumPost('${id}')" class="btn danger">ğŸ—‘ Hapus</button>` : ''}
Â  Â  </div>
Â  Â  <div id="replies-${id}" class="reply-list" style="display:none"></div>
Â  `;
Â  listEl.appendChild(item);
}

/* Fungsi format waktu helper */
function fmt(d){
Â  if(!d) return '';
Â  const dt = new Date(d);
Â  return dt.toLocaleString('id-ID', {year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
}

/* Realtime listener untuk memperbarui jumlah like forum posts (ringan: terbatas pada N terbaru) */
// Ini akan memperbarui like secara real-time di UI
function attachForumLikeListener(postId, elementId) {
    db.collection('forum_posts').doc(postId).onSnapshot(docSnap => {
        if (docSnap.exists) {
            const likes = docSnap.data().likes || [];
            const span = document.getElementById(elementId);
            if (span) span.textContent = likes.length;
        }
    });
}


// Listener utama untuk postingan forum dengan filter
let forumUnsub = null; // Untuk menghentikan listener sebelumnya
function attachFilteredForumListener(filter){
Â  if(forumUnsub) forumUnsub(); // Hentikan listener yang ada
Â  forumUnsub = null;
Â  currentFilter = filter;
Â  lastVisible = null; // Reset paginasi saat filter berubah
Â  showLoadingInList();
Â  moreBtn.style.display = 'none';

Â  let q = db.collection('forum_posts').orderBy('time','desc'); // Query dasar
Â  if(filter === 'news') q = q.where('type','==','news'); // Filter Diskusi Berita
Â  if(filter === 'local') q = q.where('type','==','local'); // Filter Diskusi Lokal

Â  // Gunakan onSnapshot untuk real-time update dan batasi jumlah awal untuk responsifitas
Â  forumUnsub = q.limit(12).onSnapshot(snapshot=>{
Â  Â  listEl.innerHTML = ''; // Bersihkan daftar yang ada
Â  Â  snapshot.docs.forEach(doc => {
Â  Â  Â  renderForumItem(doc);
      attachForumLikeListener(doc.id, `f-lk-${doc.id}`); // Attach live like listener
Â  Â  });

Â  Â  if(snapshot.docs.length >= 12){
Â  Â  Â  lastVisible = snapshot.docs[snapshot.docs.length-1];
Â  Â  Â  moreBtn.style.display = 'block';
Â  Â  Â  moreBtn.textContent = 'Muat lebih banyak';
Â  Â  } else {
Â  Â  Â  lastVisible = null;
Â  Â  Â  moreBtn.style.display='none';
Â  Â  }

Â  Â  if (snapshot.empty && !lastVisible) {
Â  Â  Â  showEmptyList();
Â  Â  }
Â  }, err => {
Â  Â  console.error('Kesalahan listener forum:', err);
Â  Â  listEl.innerHTML = '<div class="small">Gagal memuat diskusi</div>';
Â  });
}

/* Posting Forum */
postBtn.addEventListener('click', async ()=>{
Â  const text = postInput.value.trim();
Â  const type = postType.value;
Â  if(!me){ console.warn('Silakan login dulu untuk memposting.'); return; }
Â  if(!text) return;

Â  let payload = {
Â  Â  text, type, name: me.displayName||'Anonim', photo: me.photoURL||'', uid: me.uid,
Â  Â  likes: [], time: firebase.firestore.FieldValue.serverTimestamp()
Â  };
Â  // Mengekstrak judul berita jika ini adalah diskusi berita dan diformat dengan [Berita: Judul]
Â  if(type === 'news') {
Â  Â  const m = text.match(/\[Berita:\s*(.+?)(?:\s*\]|$)/); // Memperbaiki regex untuk menangani judul tanpa tutup kurung siku
Â  Â  if(m && m[1]) payload.newsTitle = m[1].trim();
Â  Â  else payload.newsTitle = null; // Jika tidak ada, pastikan null
Â  }

Â  try{
Â  Â  await db.collection('forum_posts').add(payload);
Â  Â  postInput.value = ''; // Bersihkan input
Â  Â  console.log('Postingan forum berhasil ditambahkan.');
Â  }catch(e){
Â  Â  console.error('Gagal posting forum:', e);
Â  Â  console.warn('Gagal memposting diskusi. Silakan coba lagi.');
Â  }
});

/* Toggle Like Forum Post */
async function toggleForumLike(id){
Â  if(!me){ console.warn('Silakan login dulu untuk memberi reaksi.'); return; }
Â  const ref = db.collection('forum_posts').doc(id);
Â  try{
Â  Â  const docSnap = await ref.get();
Â  Â  if (!docSnap.exists) { console.warn("Dokumen tidak ditemukan:", id); return; }
Â  Â  const currentLikes = docSnap.data().likes || [];
Â  Â  if(currentLikes.includes(me.uid)) {
Â  Â  Â  await ref.update({ likes: firebase.firestore.FieldValue.arrayRemove(me.uid) });
Â  Â  } else {
Â  Â  Â  await ref.update({ likes: firebase.firestore.FieldValue.arrayUnion(me.uid) });
Â  Â  }
Â  Â  // UI akan diperbarui secara otomatis oleh listener realtime
Â  }catch(e){
Â  Â  console.error('Gagal toggle like forum:', e);
Â  }
}

/* Hapus Forum Post (dan Balasannya) */
async function deleteForumPost(id){
Â  if(!me){ console.warn('Anda tidak memiliki izin untuk menghapus.'); return; }
Â  // Konfirmasi dengan pengguna sebelum menghapus
Â  if(!confirm('Apakah Anda yakin ingin menghapus postingan ini dan semua balasannya?')) return;

Â  try{
Â  Â  const batch = db.batch(); // Menggunakan batch untuk operasi multi-dokumen atomik
Â  Â  // Hapus semua balasan terkait postingan ini
Â  Â  const repliesSnap = await db.collection('forum_replies').where('discussionId','==',id).get();
Â  Â  repliesSnap.forEach(r => batch.delete(db.collection('forum_replies').doc(r.id)));
Â  Â  // Hapus postingan itu sendiri
Â  Â  batch.delete(db.collection('forum_posts').doc(id));
Â  Â  await batch.commit(); // Eksekusi batch operasi
Â  Â  console.log('Postingan dan balasannya berhasil dihapus.');
Â  Â  // UI akan diperbarui secara otomatis oleh listener realtime
Â  }catch(e){
Â  Â  console.error('Gagal menghapus postingan:', e);
Â  Â  console.warn('Gagal menghapus. Silakan coba lagi.');
Â  }
}

/* Balasan: Muat secara lazy saat dibuka */
async function openReplies(postId){
Â  const box = document.getElementById('replies-'+postId);
Â  if(!box) return;

Â  if(box.style.display === 'none'){
Â  Â  box.style.display = 'block';
Â  Â  // Muat balasan hanya jika belum dimuat
Â  Â  if(!box.dataset.loaded){
Â  Â  Â  box.innerHTML = '<div class="small">Memuat balasanâ€¦</div>';
      // Menggunakan onSnapshot untuk balasan real-time
      db.collection('forum_replies')
        .where('discussionId','==',postId)
        .orderBy('time','asc')
        .onSnapshot(snapshot => {
            box.innerHTML = ''; // Bersihkan balasan yang ada
            snapshot.forEach(doc => {
                const r = doc.data();
                const el = document.createElement('div'); el.className = 'reply';
                el.innerHTML = `
                    <div style="display:flex;gap:10px;align-items:center">
                        <div class="avatar">${r.photo?`<img src="${escapeHtml(r.photo)}">`:'<span>'+escapeHtml(r.name||'ğŸ‘¤').charAt(0).toUpperCase()+'</span>'}</div>
                        <div>
                            <div class="name">${escapeHtml(r.name||'Pengguna Anonim')}</div>
                            <div class="small">${fmt(r.time?.toDate?.()||r.time)}</div>
                        </div>
                    </div>
                    <div style="margin-top:8px">${escapeHtml(r.text)}</div>
                `;
                box.appendChild(el);
            });
            // Tambahkan form balasan setelah balasan dimuat
            const f = document.createElement('div'); f.className = 'reply';
            f.innerHTML = `<textarea id="reply-input-${postId}" placeholder="Tulis balasan..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee; outline:none;"></textarea><div style="margin-top:8px;display:flex;gap:8px"><button class="btn" onclick="sendReply('${postId}')">Kirim</button></div>`;
            box.appendChild(f);
            box.dataset.loaded = '1';
        }, err => {
            console.error('Gagal memuat balasan:', err);
            box.innerHTML = '<div class="small">Gagal memuat balasan.</div>';
        });
Â  Â  }
Â  } else {
Â  Â  box.style.display = 'none'; // Sembunyikan balasan
Â  }
}

// Mengirim balasan
async function sendReply(postId){
Â  if(!me){ console.warn('Silakan login dulu untuk membalas.'); return; }
Â  const ta = document.getElementById('reply-input-'+postId);
Â  if(!ta) return;
Â  const text = ta.value.trim();
Â  if(!text) return;

Â  try {
Â  Â  await db.collection('forum_replies').add({
Â  Â  Â  discussionId: postId, text, name: me.displayName||'Anonim', photo: me.photoURL||'', uid: me.uid,
Â  Â  Â  time: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  });
Â  Â  ta.value = ''; // Bersihkan input
Â  Â  console.log('Balasan berhasil dikirim.');
Â  } catch(e) {
Â  Â  console.error('Gagal mengirim balasan:', e);
Â  Â  console.warn('Gagal mengirim balasan. Silakan coba lagi.');
Â  }
}

/* ================= Binding Kontrol ================= */
refreshNews.addEventListener('click', ()=>{ newsCache.t = 0; loadNewsAndRender(); });
tabAll.addEventListener('click', ()=>{ setTab('all'); });
tabNews.addEventListener('click', ()=>{ setTab('news'); });
tabLocal.addEventListener('click', ()=>{ setTab('local'); });
moreBtn.addEventListener('click', loadForumMore); // Event listener untuk tombol "Muat lebih banyak"

// Fungsi untuk mengganti tab forum
function setTab(t){
Â  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
Â  if(t==='all') tabAll.classList.add('active');
Â  if(t==='news') tabNews.classList.add('active');
Â  if(t==='local') tabLocal.classList.add('active');
Â  listTitle.textContent = (t==='all'?'Diskusi Terbaru': (t==='news'?'Diskusi Berita':'Diskusi Lokal'));
Â  attachFilteredForumListener(t); // Lampirkan listener dengan filter baru
}

/* ================= Inisialisasi Aplikasi ================= */
(async function init(){
Â  // Pastikan Firebase Auth sudah diinisialisasi sebelum memuat data awal
Â  // Ini ditangani oleh onAuthStateChanged yang akan memicu loadNews dan loadDiscussions
Â  // setelah autentikasi anonim atau login Google selesai.
Â  await loadNewsAndRender(); // Muat dan render berita awal
Â  setTab('all'); // Set tab default ke 'Semua' dan muat diskusi
})();


/* Mengekspos fungsi-fungsi ke window agar bisa dipanggil dari inline onclick */
window.prefillFromNews = function(newsId){
Â  const n = newsItems.find(item => item.id === newsId);
Â  if(!n) return;
Â  postInput.value = `[Berita: ${n.title}] `;
Â  postType.value = 'news';
Â  // Gulir ke area posting
Â  window.scrollTo({top: document.querySelector('.post-row').offsetTop - 40, behavior: 'smooth'});
Â  // Fokus ke input setelah menggulir
Â  setTimeout(() => postInput.focus(), 500);
};
window.toggleNewsLike = toggleNewsLike;
window.toggleNewsDislike = toggleNewsDislike;
window.postNewsComment = postNewsComment;
window.toggleForumLike = toggleForumLike;
window.openReplies = openReplies;
window.deleteForumPost = deleteForumPost;
window.sendReply = sendReply;

</script>
</body>
</html>
