<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pordisk — Portal Diskusi Berita</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<style>
  :root{
    --bg:#f7f8fb; --card:#fff; --primary:#4361ee; --muted:#6b7280; --accent:#10b981;
  }
  *{box-sizing:border-box}
  body{font-family:'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#111}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:linear-gradient(90deg,#e6ffef,#d1fbe6);border-bottom:1px solid #e6eef0}
  .brand{font-weight:700;font-size:20px;padding-left:8px}
  .user-area{display:flex;align-items:center;gap:10px}
  .avatar{width:36px;height:36px;border-radius:999px;background:#ddd;overflow:hidden;display:grid;place-items:center; flex-shrink: 0;}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .btn{background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer; transition: background-color 0.2s ease;}
  .btn:hover{background-color: #364fc7;}
  .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(67,97,238,0.12); transition: background-color 0.2s ease;}
  .btn.ghost:hover{background-color:rgba(67,97,238,0.05);}
  .btn.danger{background-color: #ef4444; color: #fff; border: none;}
  .btn.danger:hover{background-color: #dc2626;}
  .btn.secondary{background-color: #e9ecef; color: #495057; border: none;}
  .btn.secondary:hover{background-color: #dee2e6;}
  .container{max-width:980px;margin:18px auto;padding:0 16px}
  .banner{position:relative;height:280px;border-radius:14px;overflow:hidden;background:#eee;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
  .slide{position:absolute;inset:0;opacity:0;transition:opacity .8s ease, transform .5s ease;display:flex;align-items:flex-end}
  .slide.active{opacity:1; z-index: 1;}
  .slide .media{position:absolute;inset:0;background-size:cover;background-position:center;filter:brightness(.6)}
  .slide .overlay{position:relative;z-index:2;padding:20px;width:100%;color:#fff;display:flex;flex-direction:column;gap:8px}
  .title{font-size:24px;font-weight:800;line-height:1.03;letter-spacing:-0.5px}
  .excerpt{font-size:14px;color:rgba(255,255,255,.95);max-width:75%}
  .slide .actions{display:flex;gap:8px;align-items:center;margin-top:6px}
  .chip{background:rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:6px;color:#fff;border:1px solid rgba(255,255,255,.06); cursor:pointer; transition: background-color 0.2s ease;}
  .chip:hover{background-color:rgba(255,255,255,.2);}
  .slider-nav{position:absolute;inset:auto 12px 12px 12px;display:flex;justify-content:space-between;z-index:3;pointer-events:none; width: calc(100% - 24px);}
  .slider-nav button{pointer-events:auto;background:rgba(0,0,0,.45);border:none;color:#fff;padding:6px;border-radius:999px;cursor:pointer; transition: background-color 0.2s ease;}
  .slider-nav button:hover{background-color:rgba(0,0,0,.6);}
  .section{margin-top:18px}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(16,24,40,0.04)}
  .post-row{display:flex;gap:10px;align-items:flex-start}
  .post-row textarea{flex:1;border-radius:10px;padding:12px;border:1px solid #e6eef0;min-height:72px;resize:vertical;font-size:15px; outline:none; transition: border-color 0.2s ease;}
  .post-row textarea:focus{border-color:var(--primary);}
  .small{font-size:13px;color:var(--muted)}
  .list .item{padding:12px;border-radius:10px;background:#fff;margin-bottom:12px;box-shadow:0 3px 10px rgba(16,24,40,0.03); border:1px solid #eee;}
  .item .meta{display:flex;gap:10px;align-items:center}
  .item .meta .name{font-weight:700}
  .item .text{margin-top:8px;white-space:pre-wrap; word-break: break-word;}
  .acts{display:flex;gap:10px;align-items:center;margin-top:10px}
  .acts button{background:transparent;border:1px solid #eee;padding:6px 10px;border-radius:999px;cursor:pointer;display:inline-flex;gap:8px;align-items:center; transition: background-color 0.2s ease;}
  .acts button:hover{background-color:#f5f5f5;}
  .acts button.active{background-color:#e0edff; border-color:#d0e0ff;}
  .reply-list{margin-top:10px;padding-left:42px; border-left: 2px dashed #e6eef0;}
  .reply{margin-top:8px;padding:8px;border-radius:8px;background:#f8fafc; border:1px solid #eef;}
  .load-more{display:block;margin:8px auto;background:transparent;border:1px dashed #dbeafe;padding:8px 12px;border-radius:8px;color:var(--primary);cursor:pointer; transition: background-color 0.2s ease;}
  .load-more:hover{background-color:#e0edff;}
  .discussion-tabs{display:flex;gap:4px;margin-bottom:12px;}
  .discussion-tabs button{padding:8px 12px;border-radius:8px;background:#f1f3f5;border:none;cursor:pointer;transition:background-color 0.2s ease;}
  .discussion-tabs button.active{background:var(--primary);color:#fff;}
  .discussion-tabs button:hover:not(.active){background:#e9ecef;}
  .news-tag{display:inline-block;background:#e6f7ff;color:#1890ff;padding:2px 8px;border-radius:4px;font-size:12px;margin-right:6px;}
  .local-tag{display:inline-block;background:#f6ffed;color:#52c41a;padding:2px 8px;border-radius:4px;font-size:12px;margin-right:6px;}
  .empty-state{text-align:center;padding:20px;color:#6b7280;}
  .empty-state svg{width:48px;height:48px;margin-bottom:12px;opacity:0.5;}
  .discussion-preview{background:#f8f9fa;border-radius:8px;padding:12px;margin-top:12px;border:1px dashed #dee2e6;}
  .discussion-preview h4{font-weight:600;margin-bottom:8px;}
  .discussion-actions{display:flex;gap:8px;margin-left:auto;}

  @media(max-width:720px){
    .banner{height:220px}
    .title{font-size:20px}
    .excerpt{max-width:100%; font-size:13px;}
    .slide .overlay{padding:16px;}
    .reply-list{padding-left:15px;}
    .user-area{gap:5px;}
    .post-row{flex-direction: column;}
    .post-row textarea{width: 100%;}
    .post-row > div:last-child { width: 100%; display: flex; gap: 8px;}
    .post-row > div:last-child select, .post-row > div:last-child button { flex: 1; }
    .discussion-tabs{overflow-x:auto;padding-bottom:8px;}
    .discussion-tabs button{flex-shrink:0;}
    .discussion-actions{flex-direction:column;margin-left:0;}
  }
</style>

</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px;padding-left:18px">
    <div class="brand">pordisk</div>
  </div>
  <div style="padding-right:18px">
    <div class="user-area">
      <div class="avatar" id="headerAvatar"><span style="font-weight:700;color:#111">👤</span></div>
      <div id="headerName" class="small">Memuat...</div>
      <button id="loginBtn" class="btn" style="margin-left:8px">Masuk</button>
      <button id="logoutBtn" class="btn ghost" style="display:none;margin-left:8px">Keluar</button>
    </div>
  </div>
</header>

<div class="container">
  <!-- Banner Berita -->
  <div class="banner card" id="banner">
    <div class="slider-nav">
      <button id="prevBtn">‹</button>
      <button id="nextBtn">›</button>
    </div>
  </div>

  <!-- Form Posting Diskusi -->
  <div class="section">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">portal diskusi disisni</div>
        <div class="small" id="postingAs">Posting sebagai: Tamu</div>
      </div>
      <div style="height:12px"></div>
      <div class="post-row">
        <textarea id="postInput" placeholder="Mulai Berdiskusi..."></textarea>
        <div style="display:flex;flex-direction:column;gap:8px">
          <select id="postType" style="padding:8px;border-radius:8px;border:1px solid #e6eef0; outline:none;">
            <option value="news">Diskusi Berita</option>
            <option value="local">Diskusi Lokal</option>
          </select>
          <button id="postBtn" class="btn">Posting</button>
        </div>
      </div>
      <div id="discussionPreview" class="discussion-preview" style="display:none">
        <h4>Preview Diskusi</h4>
        <div id="previewContent"></div>
      </div>
    </div>
  </div>

  <!-- Daftar Diskusi -->
  <div class="section">
    <div class="discussion-tabs">
      <button class="active" data-tab="all">Semua Diskusi</button>
      <button data-tab="news">Diskusi Berita</button>
      <button data-tab="local">Diskusi Lokal</button>
      <button data-tab="mine">Diskusi Saya</button>
    </div>
    <div id="list" class="list card" style="padding:14px">
      <div class="small">Memuat diskusi…</div>
    </div>
    <button id="moreBtn" class="load-more" style="display:none">Muat lebih banyak</button>
  </div>
</div>

<script>
  // ================= FIREBASE CONFIG =================
  const firebaseConfig = {
    apiKey: "AIzaSyAN825UwYIJ6zGgOpb8fYWZBeBfOSvNNU4",
    authDomain: "socialnewshariini.firebaseapp.com",
    projectId: "socialnewshariini",
    storageBucket: "socialnewshariini.appspot.com",
    messagingSenderId: "579951188459",
    appId: "1:579951188459:web:83322616a6bfd971eea1ae",
    measurementId: "G-7KSKKSPFH4"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ================= VARIABEL GLOBAL =================
  let currentUser = null;
  let newsItems = [];
  let currentSlideIndex = 0;
  let slideInterval;
  let currentTab = 'all';
  let lastVisibleDoc = null;
  let hasMorePosts = true;

  // ================= ELEMEN DOM =================
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const headerAvatar = document.getElementById('headerAvatar');
  const headerName = document.getElementById('headerName');
  const postingAs = document.getElementById('postingAs');
  const banner = document.getElementById('banner');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const postInput = document.getElementById('postInput');
  const postBtn = document.getElementById('postBtn');
  const postType = document.getElementById('postType');
  const listEl = document.getElementById('list');
  const moreBtn = document.getElementById('moreBtn');
  const discussionPreview = document.getElementById('discussionPreview');
  const previewContent = document.getElementById('previewContent');
  const tabButtons = document.querySelectorAll('.discussion-tabs button');

  // ================= FUNGSI UTAMA =================

  // 1. FUNGSI AUTENTIKASI
  function initAuth() {
    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        // User logged in
        headerName.textContent = user.displayName || user.email;
        postingAs.textContent = `Posting sebagai: ${user.displayName || user.email}`;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        
        // Set avatar
        if (user.photoURL) {
          headerAvatar.innerHTML = `<img src="${user.photoURL}" alt="Avatar">`;
        } else {
          const initial = (user.displayName || user.email).charAt(0).toUpperCase();
          headerAvatar.innerHTML = `<span style="font-weight:700;color:#111">${initial}</span>`;
        }
      } else {
        // User logged out
        headerName.textContent = 'Masuk';
        postingAs.textContent = 'Posting sebagai: Tamu';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        headerAvatar.innerHTML = '<span style="font-weight:700;color:#111">👤</span>';
      }
      
      // Reload discussions when auth state changes
      loadDiscussions();
    });

    loginBtn.addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(error => {
        console.error('Login error:', error);
        alert('Gagal login: ' + error.message);
      });
    });

    logoutBtn.addEventListener('click', () => {
      auth.signOut();
    });
  }

  // 2. FUNGSI BERITA (RSS)
  async function fetchNews() {
    try {
      const RSS_SOURCES = [
        { name: 'Detik', url: 'https://rss.detik.com/index.php/detikcom' },
        { name: 'Tribun', url: 'https://www.tribunnews.com/rss' },
        { name: 'CNN Indonesia', url: 'https://www.cnnindonesia.com/rss' }
      ];

      const allNews = [];
      
      for (const source of RSS_SOURCES) {
        try {
          const response = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(source.url)}`);
          const data = await response.json();
          
          if (data.status === 'ok' && data.items) {
            data.items.forEach(item => {
              const imageUrl = item.enclosure?.link || 
                extractFirstImage(item.description) || 
                'https://via.placeholder.com/1200x700?text=News';
              
              allNews.push({
                title: item.title || 'Tanpa Judul',
                description: stripHtml(item.description || '').substring(0, 200) + '...',
                url: item.link,
                image: imageUrl,
                source: source.name,
                publishedAt: item.pubDate || new Date().toISOString()
              });
            });
          }
        } catch (error) {
          console.error(`Error fetching ${source.name}:`, error);
        }
      }

      // Urutkan berdasarkan tanggal terbaru
      newsItems = allNews.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
      renderNewsBanner();
    } catch (error) {
      console.error('Error fetching news:', error);
      banner.innerHTML = '<div class="slide active"><div class="overlay"><div class="title">Gagal memuat berita</div></div></div>';
    }
  }

  function renderNewsBanner() {
    if (newsItems.length === 0) {
      banner.innerHTML = '<div class="slide active"><div class="overlay"><div class="title">Tidak ada berita</div></div></div>';
      return;
    }

    banner.innerHTML = '';
    
    newsItems.forEach((news, index) => {
      const slide = document.createElement('div');
      slide.className = `slide ${index === 0 ? 'active' : ''}`;
      slide.innerHTML = `
        <div class="media" style="background-image:url('${news.image}')"></div>
        <div class="overlay">
          <div class="title">${news.title}</div>
          <div class="excerpt">${news.description}</div>
          <div class="actions">
            <a class="chip" href="${news.url}" target="_blank" rel="noopener"><span>🔗</span> ${news.source}</a>
            <button class="chip" data-news-id="${index}">💬 Diskusi</button>
          </div>
        </div>
      `;
      banner.appendChild(slide);
    });

    // Setup slider controls
    setupSlider();
    
    // Event delegation untuk tombol diskusi berita
    banner.addEventListener('click', function(e) {
      if (e.target.closest('.chip') && e.target.closest('.chip').textContent.includes('Diskusi')) {
        const newsId = e.target.closest('.chip').getAttribute('data-news-id');
        if (newsId && newsItems[newsId]) {
          postInput.value = `[Berita: ${newsItems[newsId].title}] `;
          postType.value = 'news';
          postInput.focus();
          window.scrollTo({
            top: postInput.offsetTop - 20,
            behavior: 'smooth'
          });
        }
      }
    });
  }

  function setupSlider() {
    const slides = document.querySelectorAll('.slide');
    if (slides.length === 0) return;
    
    let currentIndex = 0;

    function showSlide(index) {
      slides.forEach((slide, i) => {
        slide.classList.toggle('active', i === index);
      });
      currentIndex = index;
    }

    document.getElementById('prevBtn').addEventListener('click', () => {
      showSlide((currentIndex - 1 + slides.length) % slides.length);
      resetSlideTimer();
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      showSlide((currentIndex + 1) % slides.length);
      resetSlideTimer();
    });

    // Auto slide
    resetSlideTimer();
  }

  function resetSlideTimer() {
    clearInterval(slideInterval);
    slideInterval = setInterval(() => {
      const nextBtn = document.getElementById('nextBtn');
      if (nextBtn) nextBtn.click();
    }, 8000);
  }

  // 3. FUNGSI DISKUSI
  function initDiscussion() {
    // Posting baru
    postBtn.addEventListener('click', async () => {
      if (!currentUser) {
        alert('Silakan login terlebih dahulu');
        return;
      }

      const text = postInput.value.trim();
      if (!text) return;

      try {
        await db.collection('forum_posts').add({
          text,
          author: currentUser.displayName || currentUser.email,
          authorId: currentUser.uid,
          authorPhoto: currentUser.photoURL || null,
          type: postType.value,
          likes: [],
          replyCount: 0,
          viewCount: 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        postInput.value = '';
        discussionPreview.style.display = 'none';
        
        // Reload diskusi setelah posting baru
        lastVisibleDoc = null;
        hasMorePosts = true;
        loadDiscussions();
      } catch (error) {
        console.error('Error posting:', error);
        alert('Gagal memposting diskusi');
      }
    });

    // Preview diskusi saat mengetik
    postInput.addEventListener('input', () => {
      const text = postInput.value.trim();
      if (text) {
        discussionPreview.style.display = 'block';
        previewContent.innerHTML = `
          <div class="meta">
            <div style="display:flex;gap:10px;align-items:center">
              <div class="avatar">
                ${currentUser?.photoURL ? `<img src="${currentUser.photoURL}">` : `<span>${(currentUser?.displayName || currentUser?.email || 'Tamu').charAt(0).toUpperCase()}</span>`}
              </div>
              <div>
                <div class="name">${currentUser?.displayName || currentUser?.email || 'Tamu'}</div>
                <div class="small">Sekarang</div>
              </div>
            </div>
          </div>
          <div class="text">${text}</div>
          <div class="small" style="margin-top:8px">
            ${postType.value === 'news' ? '<span class="news-tag">Diskusi Berita</span>' : '<span class="local-tag">Diskusi Lokal</span>'}
          </div>
        `;
      } else {
        discussionPreview.style.display = 'none';
      }
    });

    // Tab diskusi
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        currentTab = button.dataset.tab;
        lastVisibleDoc = null;
        hasMorePosts = true;
        loadDiscussions();
      });
    });

    // Load more button
    moreBtn.addEventListener('click', loadDiscussions);

    // Load diskusi awal
    loadDiscussions();
    
    // Event delegation untuk semua interaksi dinamis
    setupEventDelegation();
  }

  function setupEventDelegation() {
    // Event delegation untuk like, balasan, dan hapus
    listEl.addEventListener('click', function(e) {
      // Tombol like
      if (e.target.closest('.forum-like-btn')) {
        const postId = e.target.closest('.forum-like-btn').getAttribute('data-id');
        likePost(postId);
      }
      
      // Tombol balasan
      if (e.target.closest('.open-replies-btn')) {
        const btn = e.target.closest('.open-replies-btn');
        const postId = btn.getAttribute('data-id');
        const replies = document.getElementById(`replies-${postId}`);
        const isOpening = replies.style.display === 'none';
        
        replies.style.display = isOpening ? 'block' : 'none';
        btn.classList.toggle('active', isOpening);
        
        // Load replies when first opened
        if (isOpening && !replies.dataset.loaded) {
          loadReplies(postId, replies);
          replies.dataset.loaded = 'true';
        }
      }
      
      // Tombol kirim balasan
      if (e.target.closest('.send-reply-btn')) {
        const postId = e.target.closest('.send-reply-btn').getAttribute('data-id');
        sendReply(postId);
      }
      
      // Tombol hapus posting
      if (e.target.closest('.delete-post-btn')) {
        const postId = e.target.closest('.delete-post-btn').getAttribute('data-id');
        deletePost(postId);
      }
      
      // Tombol hapus balasan
      if (e.target.closest('.delete-reply-btn')) {
        const replyId = e.target.closest('.delete-reply-btn').getAttribute('data-id');
        const postId = e.target.closest('.delete-reply-btn').getAttribute('data-post-id');
        deleteReply(replyId, postId);
      }
    });
  }

  function loadDiscussions() {
    let query = db.collection('forum_posts');
    
    // Apply filters based on current tab
    switch(currentTab) {
      case 'news':
        query = query.where('type', '==', 'news');
        break;
      case 'local':
        query = query.where('type', '==', 'local');
        break;
      case 'mine':
        if (!currentUser) {
          listEl.innerHTML = '<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg><div>Silakan login untuk melihat diskusi Anda</div></div>';
          moreBtn.style.display = 'none';
          return;
        }
        query = query.where('authorId', '==', currentUser.uid);
        break;
    }
    
    // For pagination
    if (lastVisibleDoc && currentTab !== 'popular') {
      query = query.startAfter(lastVisibleDoc);
    }
    
    // Default ordering
    query = query.orderBy('createdAt', 'desc');
    
    query = query.limit(10);
    
    query.get().then(snapshot => {
      if (snapshot.empty) {
        if (lastVisibleDoc === null) { // First load
          listEl.innerHTML = '<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg><div>Belum ada diskusi</div></div>';
        }
        hasMorePosts = false;
        moreBtn.style.display = 'none';
        return;
      }
      
      if (lastVisibleDoc === null) {
        listEl.innerHTML = ''; // Clear only on first load
      }
      
      snapshot.forEach(doc => {
        const data = doc.data();
        const item = document.createElement('div');
        item.className = 'item';
        item.dataset.id = doc.id;
        item.innerHTML = `
          <div class="meta">
            <div style="display:flex;gap:10px;align-items:center">
              <div class="avatar">
                ${data.authorPhoto ? `<img src="${data.authorPhoto}">` : `<span>${data.author.charAt(0).toUpperCase()}</span>`}
              </div>
              <div>
                <div class="name">${data.author}</div>
                <div class="small">${formatDate(data.createdAt?.toDate())}</div>
              </div>
              <div class="discussion-actions">
                ${currentUser?.uid === data.authorId ? 
                  `<button class="btn danger delete-post-btn" data-id="${doc.id}">Hapus</button>` : ''}
              </div>
            </div>
          </div>
          <div class="text">${data.text}</div>
          <div class="small" style="margin-top:8px">
            ${data.type === 'news' ? '<span class="news-tag">Diskusi Berita</span>' : '<span class="local-tag">Diskusi Lokal</span>'}
            <span>👁 ${data.viewCount || 0} dilihat</span>
          </div>
          <div class="acts">
            <button class="forum-like-btn ${data.likes?.includes(currentUser?.uid) ? 'active' : ''}" data-id="${doc.id}">
              👍 <span>${data.likes?.length || 0}</span>
            </button>
            <button class="open-replies-btn" data-id="${doc.id}">
              💬 <span>${data.replyCount || 0}</span> Balasan
            </button>
          </div>
          <div id="replies-${doc.id}" class="reply-list" style="display:none">
            <div class="reply">
              <textarea class="reply-input" placeholder="Tulis balasan..." 
                style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee; outline:none;"></textarea>
              <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
                <button class="btn send-reply-btn" data-id="${doc.id}">Kirim</button>
              </div>
            </div>
          </div>
        `;
        listEl.appendChild(item);
        
        // Increment view count when post is viewed
        if (currentUser && currentUser.uid !== data.authorId) {
          db.collection('forum_posts').doc(doc.id).update({
            viewCount: firebase.firestore.FieldValue.increment(1)
          });
        }
      });
      
      // Update last visible doc for pagination
      lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
      hasMorePosts = snapshot.docs.length >= 10;
      moreBtn.style.display = hasMorePosts ? 'block' : 'none';
      
    }).catch(error => {
      console.error('Error loading discussions:', error);
      listEl.innerHTML = '<div class="small">Gagal memuat diskusi</div>';
      moreBtn.style.display = 'none';
    });
  }

  async function loadReplies(postId, container) {
    try {
      const snapshot = await db.collection('forum_replies')
        .where('postId', '==', postId)
        .orderBy('createdAt', 'asc')
        .get();
      
      // Clear existing replies except the form
      const form = container.querySelector('.reply');
      container.innerHTML = '';
      if (form) container.appendChild(form);
      
      if (snapshot.empty) {
        container.insertAdjacentHTML('afterbegin', '<div class="small">Belum ada balasan</div>');
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        const reply = document.createElement('div');
        reply.className = 'reply';
        reply.innerHTML = `
          <div style="display:flex;gap:10px;align-items:center">
            <div class="avatar">
              ${data.authorPhoto ? `<img src="${data.authorPhoto}">` : `<span>${data.author.charAt(0).toUpperCase()}</span>`}
            </div>
            <div>
              <div class="name">${data.author}</div>
              <div class="small">${formatDate(data.createdAt?.toDate())}</div>
            </div>
            ${currentUser?.uid === data.authorId ? 
              `<button class="btn danger delete-reply-btn" style="margin-left:auto;padding:4px 8px;font-size:12px;" data-id="${doc.id}" data-post-id="${postId}">Hapus</button>` : ''}
          </div>
          <div style="margin-top:8px">${data.text}</div>
        `;
        container.insertBefore(reply, form);
      });
    } catch (error) {
      console.error('Error loading replies:', error);
      container.innerHTML = '<div class="small">Gagal memuat balasan</div>';
    }
  }

  async function sendReply(postId) {
    if (!currentUser) {
      alert('Silakan login terlebih dahulu');
      return;
    }

    const input = document.querySelector(`#replies-${postId} .reply-input`);
    const text = input.value.trim();
    if (!text) return;

    try {
      // Add the reply
      await db.collection('forum_replies').add({
        postId,
        text,
        author: currentUser.displayName || currentUser.email,
        authorId: currentUser.uid,
        authorPhoto: currentUser.photoURL || null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Update reply count
      await db.collection('forum_posts').doc(postId).update({
        replyCount: firebase.firestore.FieldValue.increment(1),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      input.value = '';
      
      // Reload replies
      const repliesContainer = document.getElementById(`replies-${postId}`);
      repliesContainer.dataset.loaded = 'false';
      loadReplies(postId, repliesContainer);
    } catch (error) {
      console.error('Error sending reply:', error);
      alert('Gagal mengirim balasan');
    }
  }

  async function likePost(postId) {
    if (!currentUser) {
      alert('Silakan login terlebih dahulu');
      return;
    }

    const postRef = db.collection('forum_posts').doc(postId);
    const post = await postRef.get();
    
    if (!post.exists) return;

    const likes = post.data().likes || [];
    const userId = currentUser.uid;
    
    if (likes.includes(userId)) {
      // Unlike
      await postRef.update({
        likes: firebase.firestore.FieldValue.arrayRemove(userId)
      });
    } else {
      // Like
      await postRef.update({
        likes: firebase.firestore.FieldValue.arrayUnion(userId)
      });
    }
  }

  async function deletePost(postId) {
    if (!currentUser) return;
    
    if (!confirm('Apakah Anda yakin ingin menghapus postingan ini?')) return;

    try {
      // Delete the post
      await db.collection('forum_posts').doc(postId).delete();
      
      // Delete all replies to this post
      const replies = await db.collection('forum_replies')
        .where('postId', '==', postId)
        .get();
      
      const batch = db.batch();
      replies.forEach(doc => {
        batch.delete(doc.ref);
      });
      
      await batch.commit();
      
      // Remove the post from DOM
      document.querySelector(`.item[data-id="${postId}"]`)?.remove();
    } catch (error) {
      console.error('Error deleting post:', error);
      alert('Gagal menghapus postingan');
    }
  }

  async function deleteReply(replyId, postId) {
    if (!currentUser) return;
    
    if (!confirm('Apakah Anda yakin ingin menghapus balasan ini?')) return;

    try {
      // Delete the reply
      await db.collection('forum_replies').doc(replyId).delete();
      
      // Decrement reply count
      await db.collection('forum_posts').doc(postId).update({
        replyCount: firebase.firestore.FieldValue.increment(-1),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Remove the reply from DOM
      document.querySelector(`.delete-reply-btn[data-id="${replyId}"]`)?.closest('.reply')?.remove();
    } catch (error) {
      console.error('Error deleting reply:', error);
      alert('Gagal menghapus balasan');
    }
  }

  // ================= FUNGSI UTILITAS =================
  function formatDate(date) {
    if (!date) return '';
    return date.toLocaleString('id-ID', {
      day: 'numeric', month: 'short', year: 'numeric',
      hour: '2-digit', minute: '2-digit'
    });
  }

  function stripHtml(html) {
    return html.replace(/<[^>]*>?/gm, '');
  }

  function extractFirstImage(html) {
    const imgRegex = /<img[^>]+src="([^">]+)"/;
    const match = html.match(imgRegex);
    return match ? match[1] : null;
  }

  // ================= INISIALISASI APLIKASI =================
  function initApp() {
    initAuth();
    fetchNews();
    initDiscussion();
  }

  // Jalankan aplikasi
  initApp();
</script>

</body>
</html>
