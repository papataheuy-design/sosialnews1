<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Portal Diskusi Berita</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    .slide { display: none; }
    .active-slide { display: block; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- Header -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Portal Diskusi Berita</h1>
    <div id="userSection">
      <button id="loginBtn" class="bg-blue-500 text-white px-4 py-1 rounded">Login Google</button>
      <div id="userInfo" class="hidden flex items-center gap-2">
        <img id="userPic" class="w-8 h-8 rounded-full"/>
        <span id="userName"></span>
        <button id="logoutBtn" class="bg-red-500 text-white px-2 py-1 rounded">Logout</button>
      </div>
    </div>
  </header>

  <!-- Slider Berita -->
  <section class="max-w-3xl mx-auto mt-6">
    <div id="newsSlider" class="relative overflow-hidden rounded-lg shadow-lg">
      <!-- slides akan diisi dengan JS -->
    </div>
    <div class="flex justify-between mt-2">
      <button id="prevBtn" class="bg-gray-300 px-3 py-1 rounded">Prev</button>
      <button id="nextBtn" class="bg-gray-300 px-3 py-1 rounded">Next</button>
    </div>
  </section>

  <!-- Forum Diskusi -->
  <section class="max-w-3xl mx-auto mt-8">
    <h2 class="text-lg font-semibold mb-2">Forum Diskusi</h2>
    <form id="forumForm" class="mb-4 flex gap-2">
      <input id="forumInput" class="flex-grow border p-2 rounded" placeholder="Tulis sesuatu..."/>
      <button class="bg-green-500 text-white px-4 py-2 rounded">Kirim</button>
    </form>
    <div id="forumPosts" class="space-y-4">
      <!-- posting diskusi akan diisi dengan JS -->
    </div>
  </section>

  <script>
    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAN825UwYIJ6zGgOpb8fYWZBeBfOSvNNU4",
      authDomain: "socialnewshariini.firebaseapp.com",
      projectId: "socialnewshariini",
      storageBucket: "socialnewshariini.firebasestorage.app",
      messagingSenderId: "579951188459",
      appId: "1:579951188459:web:83322616a6bfd971eea1ae",
      measurementId: "G-7KSKKSPFH4"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- Login/Logout ---
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfo = document.getElementById('userInfo');
    const userName = document.getElementById('userName');
    const userPic = document.getElementById('userPic');
    let currentUser = null;

    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };
    logoutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loginBtn.classList.add('hidden');
        userInfo.classList.remove('hidden');
        userName.textContent = user.displayName;
        userPic.src = user.photoURL;
      } else {
        currentUser = null;
        loginBtn.classList.remove('hidden');
        userInfo.classList.add('hidden');
      }
    });

    // --- Slider Berita ---
    const newsSlider = document.getElementById('newsSlider');
    let slideIndex = 0, slides = [];

    async function loadRSS() {
      const feeds = [
        "https://rss.detik.com/index.php/detikcom",
        "https://www.cnnindonesia.com/nasional/rss",
        "https://www.tribunnews.com/rss"
      ];
      for (let url of feeds) {
        const res = await fetch("https://api.allorigins.win/get?url=" + encodeURIComponent(url));
        const data = await res.json();
        const parser = new DOMParser();
        const xml = parser.parseFromString(data.contents, "text/xml");
        const items = xml.querySelectorAll("item");
        items.forEach((item, i) => {
          if (i < 3) { // ambil 3 per sumber
            const title = item.querySelector("title").textContent;
            const link = item.querySelector("link").textContent;
            const desc = item.querySelector("description").textContent;
            const slide = document.createElement("div");
            slide.className = "slide p-4 bg-gray-800 text-white relative";
            slide.innerHTML = `
              <h3 class="text-lg font-bold">${title}</h3>
              <p class="text-sm">${desc.substring(0,150)}...</p>
              <a href="${link}" target="_blank" class="underline">Sumber</a>
              <div class="mt-2">
                <button class="bg-blue-500 text-white px-2 py-1 rounded reactBtn">👍</button>
                <button class="bg-red-500 text-white px-2 py-1 rounded reactBtn">👎</button>
                <button class="bg-green-500 text-white px-2 py-1 rounded commentBtn">💬 Diskusi</button>
              </div>
            `;
            slide.dataset.title = title;
            slide.dataset.link = link;
            newsSlider.appendChild(slide);
            slides.push(slide);
          }
        });
      }
      showSlide(0);
    }

    function showSlide(i) {
      slides.forEach(s => s.classList.remove('active-slide'));
      slides[i].classList.add('active-slide');
      slideIndex = i;
    }

    document.getElementById('nextBtn').onclick = () => {
      showSlide((slideIndex+1)%slides.length);
    };
    document.getElementById('prevBtn').onclick = () => {
      showSlide((slideIndex-1+slides.length)%slides.length);
    };

    setInterval(()=>{ showSlide((slideIndex+1)%slides.length); },12000);

    // --- Komentar dari berita ke Forum ---
    newsSlider.addEventListener('click', e => {
      if (e.target.classList.contains('commentBtn')) {
        if (!currentUser) { alert("Harus login!"); return; }
        const slide = e.target.closest('.slide');
        const text = prompt("Tulis komentar:");
        if (text) {
          db.collection("forum_posts").add({
            text,
            newsTitle: slide.dataset.title,
            newsLink: slide.dataset.link,
            uid: currentUser.uid,
            author: currentUser.displayName,
            photo: currentUser.photoURL,
            time: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      }
    });

    // --- Forum Diskusi ---
    const forumForm = document.getElementById('forumForm');
    const forumInput = document.getElementById('forumInput');
    const forumPosts = document.getElementById('forumPosts');

    forumForm.onsubmit = e => {
      e.preventDefault();
      if (!currentUser) { alert("Harus login!"); return; }
      if (forumInput.value.trim()) {
        db.collection("forum_posts").add({
          text: forumInput.value,
          uid: currentUser.uid,
          author: currentUser.displayName,
          photo: currentUser.photoURL,
          time: firebase.firestore.FieldValue.serverTimestamp()
        });
        forumInput.value = "";
      }
    };

    db.collection("forum_posts").orderBy("time","desc").onSnapshot(snapshot=>{
      forumPosts.innerHTML = "";
      snapshot.forEach(doc=>{
        const d = doc.data();
        const div = document.createElement("div");
        div.className = "bg-white p-3 rounded shadow";
        div.innerHTML = `
          <div class="flex items-center gap-2 mb-1">
            <img src="${d.photo}" class="w-6 h-6 rounded-full"/> 
            <span class="font-semibold">${d.author}</span>
          </div>
          ${d.newsTitle ? `<div class="text-xs text-blue-500">Komentar pada: <a href="${d.newsLink}" target="_blank">${d.newsTitle}</a></div>` : ""}
          <p>${d.text}</p>
          <div class="flex gap-2 mt-1">
            <button class="likeBtn">👍</button>
            <button class="dislikeBtn">👎</button>
            <button class="replyBtn">Balas</button>
            ${currentUser && currentUser.uid === d.uid ? `<button class="deleteBtn text-red-500">Hapus</button>` : ""}
          </div>
          <div class="replies ml-4 mt-1"></div>
        `;
        // delete action
        div.querySelectorAll('.deleteBtn').forEach(btn=>{
          btn.onclick = ()=> db.collection("forum_posts").doc(doc.id).delete();
        });
        // reply action
        div.querySelectorAll('.replyBtn').forEach(btn=>{
          btn.onclick = ()=>{
            const reply = prompt("Tulis balasan:");
            if (reply) {
              db.collection("forum_replies").add({
                postId: doc.id,
                text: reply,
                uid: currentUser.uid,
                author: currentUser.displayName,
                photo: currentUser.photoURL,
                time: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
          };
        });
        // load replies
        db.collection("forum_replies").where("postId","==",doc.id).orderBy("time").onSnapshot(sn=>{
          const repDiv = div.querySelector('.replies');
          repDiv.innerHTML = "";
          sn.forEach(r=>{
            const rd = r.data();
            const rdv = document.createElement("div");
            rdv.className = "bg-gray-100 p-2 rounded mt-1";
            rdv.innerHTML = `<b>${rd.author}:</b> ${rd.text} ${currentUser && currentUser.uid===rd.uid?'<button class="text-red-500 deleteReplyBtn">hapus</button>':''}`;
            if (rd.uid=== (currentUser?currentUser.uid:null)) {
              rdv.querySelector('.deleteReplyBtn').onclick=()=> db.collection("forum_replies").doc(r.id).delete();
            }
            repDiv.appendChild(rdv);
          });
        });
        forumPosts.appendChild(div);
      });
    });

    loadRSS();
  </script>
</body>
</html>
