<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pordisk ‚Äî Portal Diskusi Berita</title>

<!-- Minimal modern styling -->
<style>
  :root{
    --bg:#f7f8fb; --card:#fff; --primary:#4361ee; --muted:#6b7280; --accent:#10b981;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#111}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:linear-gradient(90deg,#e6ffef,#d1fbe6);border-bottom:1px solid #e6eef0}
  .brand{font-weight:700;font-size:20px;padding-left:8px}
  .user-area{display:flex;align-items:center;gap:10px}
  .avatar{width:36px;height:36px;border-radius:999px;background:#ddd;overflow:hidden;display:grid;place-items:center}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .btn{background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(67,97,238,0.12)}
  .container{max-width:980px;margin:18px auto;padding:0 16px}
  /* Banner / Slider */
  .banner{position:relative;height:420px;border-radius:14px;overflow:hidden;background:#eee;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
  .slide{position:absolute;inset:0;opacity:0;transition:opacity .8s ease, transform .5s ease;display:flex;align-items:flex-end}
  .slide.active{opacity:1}
  .slide .media{position:absolute;inset:0;background-size:cover;background-position:center;filter:brightness(.6)}
  .slide .overlay{position:relative;z-index:2;padding:28px;width:100%;color:#fff;display:flex;flex-direction:column;gap:12px}
  .title{font-size:28px;font-weight:800;line-height:1.03;letter-spacing:-0.5px}
  .excerpt{font-size:16px;color:rgba(255,255,255,.95);max-width:75%}
  .slide .actions{display:flex;gap:10px;align-items:center;margin-top:6px}
  .chip{background:rgba(255,255,255,.12);padding:8px 12px;border-radius:999px;display:inline-flex;align-items:center;gap:8px;color:#fff;border:1px solid rgba(255,255,255,.06)}
  .slider-nav{position:absolute;inset:auto 12px 12px 12px;display:flex;justify-content:space-between;z-index:3;pointer-events:none}
  .slider-nav button{pointer-events:auto;background:rgba(0,0,0,.45);border:none;color:#fff;padding:8px;border-radius:999px;cursor:pointer}
  .news-controls{display:flex;gap:10px;align-items:center}
  .news-controls button{background:rgba(255,255,255,.12);border:0;color:#fff;padding:8px 12px;border-radius:999px;cursor:pointer}
  /* discussion area */
  .section{margin-top:18px}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(16,24,40,0.04)}
  .post-row{display:flex;gap:10px;align-items:flex-start}
  .post-row textarea{flex:1;border-radius:10px;padding:12px;border:1px solid #e6eef0;min-height:72px;resize:vertical;font-size:15px}
  .small{font-size:13px;color:var(--muted)}
  .list .item{padding:12px;border-radius:10px;background:#fff;margin-bottom:12px;box-shadow:0 3px 10px rgba(16,24,40,0.03)}
  .item .meta{display:flex;gap:10px;align-items:center}
  .item .meta .name{font-weight:700}
  .item .text{margin-top:8px;white-space:pre-wrap}
  .acts{display:flex;gap:10px;align-items:center;margin-top:10px}
  .acts button{background:transparent;border:1px solid #eee;padding:6px 10px;border-radius:999px;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
  .reply-list{margin-top:10px;padding-left:42px}
  .reply{margin-top:8px;padding:8px;border-radius:8px;background:#f8fafc}
  .load-more{display:block;margin:8px auto;background:transparent;border:1px dashed #dbeafe;padding:8px 12px;border-radius:8px;color:var(--primary);cursor:pointer}
  /* responsive */
  @media(max-width:720px){
    .title{font-size:20px}
    .excerpt{max-width:100%}
    .banner{height:320px}
  }
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px;padding-left:18px">
    <div class="brand">pordisk</div>
  </div>
  <div style="padding-right:18px">
    <div class="user-area">
      <div class="avatar" id="headerAvatar"><span style="font-weight:700;color:#fff">üë§</span></div>
      <div id="headerName" class="small">Masuk</div>
      <button id="loginBtn" class="btn" style="margin-left:8px">Masuk</button>
      <button id="logoutBtn" class="btn ghost" style="display:none;margin-left:8px">Keluar</button>
    </div>
  </div>
</header>

<div class="container">
  <!-- Banner / Slider -->
  <div class="banner card" id="banner">
    <!-- slides injected here -->
    <div class="slider-nav">
      <button id="prevBtn" aria-label="prev">‚Äπ</button>
      <button id="nextBtn" aria-label="next">‚Ä∫</button>
    </div>
  </div>

  <!-- Tabs and Controls -->
  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:12px">
    <div style="display:flex;gap:10px">
      <button class="tab active" id="tabAll">Semua</button>
      <button class="tab" id="tabNews">Diskusi Berita</button>
      <button class="tab" id="tabLocal">Diskusi Lokal</button>
    </div>
    <div class="news-controls">
      <button id="refreshNews" title="Update berita">Refresh Berita</button>
    </div>
  </div>

  <!-- Post form -->
  <div class="section">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">portal diskusi disisni</div>
        <div class="small" id="postingAs"></div>
      </div>
      <div style="height:12px"></div>
      <div class="post-row">
        <textarea id="postInput" placeholder="Mulai Berdiskusi"></textarea>
        <div style="display:flex;flex-direction:column;gap:8px">
          <select id="postType" style="padding:8px;border-radius:8px;border:1px solid #e6eef0">
            <option value="news">Diskusi Berita</option>
            <option value="local">Diskusi Lokal</option>
          </select>
          <button id="postBtn" class="btn">Posting</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Discussion list -->
  <div class="section">
    <h3 id="listTitle">Diskusi Terbaru</h3>
    <div id="list" class="list card" style="padding:14px">
      <div class="small">Memuat diskusi‚Ä¶</div>
    </div>
    <button id="moreBtn" class="load-more" style="display:none">Muat lebih banyak</button>
  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
/* ================= Firebase config (pakai konfigurasi yang kamu berikan) ================= */
const firebaseConfig = {
  apiKey: "AIzaSyAN825UwYIJ6zGgOpb8fYWZBeBfOSvNNU4",
  authDomain: "socialnewshariini.firebaseapp.com",
  projectId: "socialnewshariini",
  storageBucket: "socialnewshariini.firebasestorage.app",
  messagingSenderId: "579951188459",
  appId: "1:579951188459:web:83322616a6bfd971eea1ae",
  measurementId: "G-7KSKKSPFH4"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= State ================= */
let me = null;
let slides = [];       // DOM slides
let newsItems = [];    // combined news
let slideIndex = 0;
let slideTimer = null;
const slideIntervalMs = 12000; // 12s
const rssSources = [
  { name: 'Detik', url: 'https://rss.detik.com/index.php/detikcom' },
  { name: 'Tribun', url: 'https://www.tribunnews.com/rss' },
  { name: 'CNN', url: 'https://www.cnnindonesia.com/rss' }
];
const newsCache = { data: null, t: 0, ttl: 10*60*1000 }; // 10 minutes cache

/* ================= Auth handlers ================= */
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const headerAvatar = document.getElementById('headerAvatar');
const headerName = document.getElementById('headerName');
const postingAs = document.getElementById('postingAs');

loginBtn.addEventListener('click', async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  try { await auth.signInWithPopup(provider); }
  catch(e){ console.error('Login failed', e); alert('Login gagal'); }
});
logoutBtn.addEventListener('click', async () => { await auth.signOut(); });

auth.onAuthStateChanged(user => {
  me = user;
  if (user && !user.isAnonymous) {
    headerAvatar.innerHTML = `<img src="${user.photoURL || ''}" alt="avatar">`;
    headerName.textContent = user.displayName || user.email;
    loginBtn.style.display = 'none';
    logoutBtn.style.display = 'inline-block';
    postingAs.textContent = 'Posting sebagai ' + (user.displayName || 'Pengguna');
  } else {
    headerAvatar.innerHTML = `<span style="font-weight:700;color:#111">üë§</span>`;
    headerName.textContent = 'Masuk';
    loginBtn.style.display = 'inline-block';
    logoutBtn.style.display = 'none';
    postingAs.textContent = '';
  }
});

/* ================= News: fetch & render slides ================= */

function dedupeByTitle(arr) {
  const seen = new Set();
  const out = [];
  for(const a of arr){
    const k = (a.title || '').trim().toLowerCase();
    if(!seen.has(k)){ seen.add(k); out.push(a); }
  }
  return out;
}

async function fetchRssMultiple() {
  // use cache if still valid
  if (newsCache.data && Date.now() - newsCache.t < newsCache.ttl) return newsCache.data;
  try {
    const promises = rssSources.map(s => fetch('https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent(s.url)).then(r => r.json()).catch(()=>({items:[]})) );
    const results = await Promise.allSettled(promises);
    let items = [];
    for (const r of results) {
      if (r.status === 'fulfilled' && r.value.items) {
        for (const it of r.value.items) {
          items.push({
            id: it.guid || it.link || Math.random().toString(36).slice(2),
            title: it.title || 'No title',
            description: (it.description || it.content || '').replace(/<[^>]+>/g,'').trim(),
            thumbnail: (it.enclosure && it.enclosure.link) || ( (it.thumbnail) ? it.thumbnail : null ) || ( (it.content && ( (it.content.match(/https?:\/\/\S+\.(jpg|png|jpeg|webp)/i)||[])[0]) ) || 'https://via.placeholder.com/1200x700?text=NEWS' ),
            link: it.link || '#',
            pubDate: it.pubDate || (it.isoDate || new Date().toISOString())
          });
        }
      }
    }
    // dedupe by title and sort by pubDate desc
    items = dedupeByTitle(items);
    items.sort((a,b) => new Date(b.pubDate) - new Date(a.pubDate));
    // cache and limit
    const limited = items.slice(0, 15);
    newsCache.data = limited; newsCache.t = Date.now();
    return limited;
  } catch (e) {
    console.error('RSS fetch error', e);
    return [];
  }
}

async function loadNewsAndRender() {
  const banner = document.getElementById('banner');
  banner.querySelectorAll('.slide').forEach(n=>n.remove());
  // show temporary loading
  const loading = document.createElement('div');
  loading.className = 'slide active';
  loading.innerHTML = `<div class="media" style="background:#111"></div><div class="overlay"><div class="title">Memuat berita‚Ä¶</div></div>`;
  banner.appendChild(loading);

  newsItems = await fetchRssMultiple();
  if (!newsItems || newsItems.length === 0) {
    loading.querySelector('.title').textContent = 'Tidak ada berita';
    return;
  }
  // remove loading
  banner.querySelectorAll('.slide').forEach(n=>n.remove());

  newsItems.forEach((n,i) => {
    const s = document.createElement('div');
    s.className = 'slide' + (i===0 ? ' active' : '');
    s.innerHTML = `
      <div class="media" style="background-image:url('${n.thumbnail.replace(/'/g,"\\'")}')"></div>
      <div class="overlay">
        <div class="title">${escapeHtml(n.title)}</div>
        <div class="excerpt">${escapeHtml(n.description.slice(0,220))}</div>
        <div class="actions">
          <a class="chip" href="${n.link}" target="_blank" rel="noopener"><span>üîó</span> Sumber</a>
          <button class="chip" onclick="prefillFromNews(${i})">üí¨ Diskusi</button>
          <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
            <button class="chip" onclick="toggleNewsLike('${n.id}', this)"><span>üëç</span> <span class="nl-count">0</span></button>
            <button class="chip" onclick="toggleNewsDislike('${n.id}', this)"><span>üëé</span> <span class="nd-count">0</span></button>
          </div>
        </div>
        <div style="height:8px"></div>
        <div style="display:flex;gap:10px;align-items:center">
          <input id="news-comment-${escapeId(n.id)}" placeholder="beri tanggapan berita ini" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff">
          <button class="btn" onclick="postNewsComment('${n.id}')">Kirim</button>
        </div>
      </div>
    `;
    document.getElementById('banner').appendChild(s);

    // load like/dislike counts & comments realtime
    watchNewsLikeCounts(n.id, s);
    watchNewsCommentsCount(n.id, s);
  });

  resetSlideTimer();
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function escapeId(id){ return String(id).replace(/[^a-z0-9_\-]/gi,'_'); }

/* Slider controls */
document.getElementById('prevBtn').addEventListener('click', ()=>{ moveSlide(-1); resetSlideTimer(); });
document.getElementById('nextBtn').addEventListener('click', ()=>{ moveSlide(1); resetSlideTimer(); });

function moveSlide(delta){
  const slides = Array.from(document.querySelectorAll('#banner .slide'));
  if (slides.length <= 1) return;
  slides[slideIndex].classList.remove('active');
  slideIndex = (slideIndex + delta + slides.length) % slides.length;
  slides[slideIndex].classList.add('active');
}
function resetSlideTimer(){
  clearInterval(slideTimer);
  slideTimer = setInterval(()=> moveSlide(1), slideIntervalMs);
}

/* ================= News Likes / Dislikes & comments ================= */
function newsLikeDocId(newsId, uid){ return `${newsId}_like_${uid}`; }
function newsDislikeDocId(newsId, uid){ return `${newsId}_dislike_${uid}`; }

async function toggleNewsLike(newsId, btn){
  if(!me){ alert('Silakan login dulu'); return; }
  const docRef = db.collection('news_likes').doc(newsLikeDocId(newsId, me.uid));
  const doc = await docRef.get();
  if(doc.exists){ await docRef.delete(); }
  else {
    // remove dislike if exists
    const disRef = db.collection('news_dislikes').doc(newsDislikeDocId(newsId, me.uid));
    if((await disRef.get()).exists) await disRef.delete();
    await docRef.set({newsId, uid: me.uid, ts: firebase.firestore.FieldValue.serverTimestamp()});
  }
}
async function toggleNewsDislike(newsId, btn){
  if(!me){ alert('Silakan login dulu'); return; }
  const docRef = db.collection('news_dislikes').doc(newsDislikeDocId(newsId, me.uid));
  const doc = await docRef.get();
  if(doc.exists){ await docRef.delete(); }
  else {
    const likeRef = db.collection('news_likes').doc(newsLikeDocId(newsId, me.uid));
    if((await likeRef.get()).exists) await likeRef.delete();
    await docRef.set({newsId, uid: me.uid, ts: firebase.firestore.FieldValue.serverTimestamp()});
  }
}
function watchNewsLikeCounts(newsId, slideEl){
  // likes
  db.collection('news_likes').where('newsId','==',newsId).onSnapshot(snap=>{
    const c = snap.size;
    const span = slideEl.querySelector('.nl-count');
    if(span) span.textContent = c;
  });
  // dislikes
  db.collection('news_dislikes').where('newsId','==',newsId).onSnapshot(snap=>{
    const c = snap.size;
    const span = slideEl.querySelector('.nd-count');
    if(span) span.textContent = c;
  });
}
function watchNewsCommentsCount(newsId, slideEl){
  db.collection('news_comments').where('newsId','==',newsId).onSnapshot(snap=>{
    // optionally show count somewhere; we rely on forum list for comments display
  });
}
async function postNewsComment(newsId){
  if(!me){ alert('Silakan login dulu'); return; }
  const id = escapeId(newsId);
  const input = document.getElementById('news-comment-' + id);
  if(!input) return;
  const text = input.value.trim();
  if(!text) return;
  await db.collection('news_comments').add({
    newsId, text, name: me.displayName||'Anonim', photo: me.photoURL||'', uid: me.uid,
    ts: firebase.firestore.FieldValue.serverTimestamp()
  });
  input.value = '';
  // Also create a forum post entry that references this news so it appears in forum list
  await db.collection('forum_posts').add({
    type:'news', newsId, newsTitle: newsItems.find(n=>n.id===newsId)?.title || null,
    text, name: me.displayName||'Anonim', photo: me.photoURL||'', uid: me.uid,
    likes: [], time: firebase.firestore.FieldValue.serverTimestamp()
  });
  // after posting, refresh forum list (we use onSnapshot below so it'll update automatically)
  loadForumInitial(true);
}

/* ================= Forum (posts, replies, pagination) ================= */
const listEl = document.getElementById('list');
const moreBtn = document.getElementById('moreBtn');
let lastVisible = null;
let loadingForum = false;

function showLoadingInList(){ listEl.innerHTML = '<div class="small">Memuat diskusi‚Ä¶</div>'; }
function showEmptyList(){ listEl.innerHTML = '<div class="small">Belum ada diskusi</div>'; }

async function loadForumInitial(reset){
  if(loadingForum) return;
  loadingForum = true;
  if(reset){ lastVisible = null; showLoadingInList(); moreBtn.style.display='none'; }
  try{
    let q = db.collection('forum_posts').orderBy('time','desc').limit(12);
    if(lastVisible) q = q.startAfter(lastVisible);
    const snap = await q.get();
    if(reset) listEl.innerHTML = '';
    if(snap.empty && !lastVisible){ showEmptyList(); loadingForum = false; return; }
    snap.docs.forEach(doc => renderForumItem(doc));
    if(snap.docs.length >= 12){
      lastVisible = snap.docs[snap.docs.length-1];
      moreBtn.style.display = 'block';
    } else { moreBtn.style.display='none'; }
  }catch(e){
    console.error('loadForum', e);
    if(!lastVisible) listEl.innerHTML = '<div class="small">Gagal memuat diskusi</div>';
  } finally { loadingForum = false; }
}

// render one forum doc
function renderForumItem(doc){
  const v = doc.data(); const id = doc.id;
  const item = document.createElement('div'); item.className = 'item';
  const canDelete = me && me.uid === v.uid;
  const liked = Array.isArray(v.likes) && me && v.likes.includes(me.uid);
  item.innerHTML = `
    <div class="meta"><div style="display:flex;gap:10px;align-items:center">
      <div class="avatar">${v.photo? `<img src="${v.photo}">` : '<span>üë§</span>'}</div>
      <div><div class="name">${escapeHtml(v.name||'Pengguna')}</div><div class="small">${fmt(v.time?.toDate?.() || v.time)}</div></div>
    </div></div>
    <div class="text">${escapeHtml(v.text)}</div>
    ${v.type === 'news' && v.newsTitle ? `<div class="news-ref"><strong>Referensi:</strong> ${escapeHtml(v.newsTitle)}</div>` : ''}
    <div class="acts">
      <button onclick="toggleForumLike('${id}', ${liked})">üëç <span id="f-lk-${id}">${(v.likes||[]).length}</span></button>
      <button onclick="openReplies('${id}')">üí¨ Balasan</button>
      ${canDelete ? `<button onclick="deleteForumPost('${id}')" class="danger">üóë Hapus</button>` : ''}
    </div>
    <div id="replies-${id}" class="reply-list" style="display:none"></div>
  `;
  listEl.appendChild(item);
}

/* helper time formatting */
function fmt(d){
  if(!d) return '';
  const dt = new Date(d);
  return dt.toLocaleString('id-ID', {year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
}

/* Realtime listener to keep live updates for forum posts (lightweight: limited to recent N via onSnapshot) */
function attachForumRealtime(){
  // listen recent 50 posts (for live updates, but we keep initial pagination)
  db.collection('forum_posts').orderBy('time','desc').limit(50).onSnapshot(snapshot=>{
    // rebuild visible list: easiest approach: replace current list with ordered docs
    // but keep pagination controls ‚Äî this listener is primarily to reflect live changes
    const docs = snapshot.docs;
    listEl.innerHTML = '';
    docs.forEach(doc => renderForumItem(doc));
    // if there are more than pageSize, we show moreBtn (the pagination loader still works)
    moreBtn.style.display = docs.length >= 12 ? 'block' : 'none';
  });
}

/* Posting forum */
document.getElementById('postBtn').addEventListener('click', async ()=>{
  const text = document.getElementById('postInput').value.trim();
  const type = document.getElementById('postType').value;
  if(!me){ alert('Login dulu'); return; }
  if(!text) return;
  let payload = {
    text, type, name: me.displayName||'Pengguna', photo: me.photoURL||'', uid: me.uid,
    likes: [], time: firebase.firestore.FieldValue.serverTimestamp()
  };
  // if postType is 'news' and textarea contains [Berita: title], extract
  const m = text.match(/\[Berita:\s*(.+?)\s*\]/);
  if(type === 'news' && m) payload.newsTitle = m[1];
  try{
    await db.collection('forum_posts').add(payload);
    document.getElementById('postInput').value = '';
    // loadForumInitial(true); // live listener will update automatically
  }catch(e){ console.error('post forum', e); alert('Gagal posting'); }
});

/* forum like toggle */
async function toggleForumLike(id, liked){
  if(!me){ alert('Login dulu'); return; }
  const ref = db.collection('forum_posts').doc(id);
  try{
    if(liked) await ref.update({ likes: firebase.firestore.FieldValue.arrayRemove(me.uid) });
    else await ref.update({ likes: firebase.firestore.FieldValue.arrayUnion(me.uid) });
    // UI auto updated by realtime listener
  }catch(e){ console.error(e); }
}

/* delete forum post (and its replies) */
async function deleteForumPost(id){
  if(!me) return;
  if(!confirm('Hapus post ini dan semua balasan?')) return;
  try{
    const batch = db.batch();
    const replies = await db.collection('forum_replies').where('discussionId','==',id).get();
    replies.forEach(r => batch.delete(db.collection('forum_replies').doc(r.id)));
    batch.delete(db.collection('forum_posts').doc(id));
    await batch.commit();
  }catch(e){ console.error(e); alert('Gagal menghapus'); }
}

/* replies: lazy load when opened */
async function openReplies(postId){
  const box = document.getElementById('replies-'+postId);
  if(!box) return;
  if(box.style.display === 'none'){
    box.style.display = 'block';
    // if empty, load replies
    if(!box.dataset.loaded){
      box.innerHTML = '<div class="small">Memuat balasan‚Ä¶</div>';
      const snap = await db.collection('forum_replies').where('discussionId','==',postId).orderBy('time','asc').limit(200).get();
      box.innerHTML = '';
      snap.forEach(doc => {
        const r = doc.data();
        const el = document.createElement('div'); el.className = 'reply';
        el.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div class="avatar">${r.photo?`<img src="${r.photo}">`:'<span>üë§</span>'}</div><div><div class="name">${escapeHtml(r.name||'Pengguna')}</div><div class="small">${fmt(r.time?.toDate?.()||r.time)}</div></div></div><div style="margin-top:8px">${escapeHtml(r.text)}</div>`;
        box.appendChild(el);
      });
      // add reply form
      const f = document.createElement('div'); f.className = 'reply';
      f.innerHTML = `<textarea id="reply-input-${postId}" placeholder="Tulis balasan..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee"></textarea><div style="margin-top:8px;display:flex;gap:8px"><button class="btn" onclick="sendReply('${postId}')">Kirim</button></div>`;
      box.appendChild(f);
      box.dataset.loaded = '1';
    }
  } else { box.style.display = 'none'; }
}

async function sendReply(postId){
  if(!me){ alert('Login dulu'); return; }
  const ta = document.getElementById('reply-input-'+postId);
  if(!ta) return;
  const text = ta.value.trim(); if(!text) return;
  await db.collection('forum_replies').add({
    discussionId: postId, text, name: me.displayName||'Pengguna', photo: me.photoURL||'', uid: me.uid,
    time: firebase.firestore.FieldValue.serverTimestamp()
  });
  ta.value = '';
  // reload replies
  const box = document.getElementById('replies-'+postId);
  if(box){
    box.dataset.loaded = ''; // force reload
    openReplies(postId);
  }
}

/* ================= Realtime for news_comments -> also show as forum item when created by users (already handled on postNewsComment) ================= */
/* We already push notification into forum_posts when user comments on news */

/* ================= Utility watchers for news like/dislike counts were set during renderSlides ================= */

/* ================= Bind controls ================= */
document.getElementById('refreshNews').addEventListener('click', ()=>{ newsCache.t = 0; loadNewsAndRender(); });
document.getElementById('tabAll').addEventListener('click', ()=>{ document.getElementById('postType').value='news'; setTab('all'); });
document.getElementById('tabNews').addEventListener('click', ()=>{ document.getElementById('postType').value='news'; setTab('news'); });
document.getElementById('tabLocal').addEventListener('click', ()=>{ document.getElementById('postType').value='local'; setTab('local'); });

function setTab(t){
  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
  if(t==='all') document.getElementById('tabAll').classList.add('active');
  if(t==='news') document.getElementById('tabNews').classList.add('active');
  if(t==='local') document.getElementById('tabLocal').classList.add('active');
  // change list title and filter (we use realtime feed that shows recent posts)
  document.getElementById('listTitle').textContent = (t==='all'?'Diskusi Terbaru': (t==='news'?'Diskusi Berita':'Diskusi Lokal'));
  // for simplicity with realtime, we can filter client-side when rendering; but easier is to re-query
  // Here we'll re-attach a listener with filter:
  attachFilteredForumListener(t);
}

/* Attach simple filtered realtime listener for forum posts (recent N) */
let forumUnsub = null;
function attachFilteredForumListener(filter){
  if(forumUnsub) forumUnsub(); forumUnsub = null;
  let q = db.collection('forum_posts').orderBy('time','desc').limit(50);
  if(filter === 'news') q = q.where('type','==','news');
  if(filter === 'local') q = q.where('type','==','local');
  forumUnsub = q.onSnapshot(snapshot=>{
    listEl.innerHTML = '';
    snapshot.docs.forEach(doc => renderForumItem(doc));
  }, err => {
    console.error('forum listener', err);
    listEl.innerHTML = '<div class="small">Gagal memuat diskusi</div>';
  });
}

/* initial load */
(async function init(){
  await loadNewsAndRender();
  // attach initial forum listener (all)
  attachFilteredForumListener('all');
})();

/* helper: when user posts comment on news, also create forum post above
 * (already done in postNewsComment)
 */

/*Expose some functions for inline onclicks*/
window.prefillFromNews = function(i){
  const n = newsItems[i];
  if(!n) return;
  document.getElementById('postInput').value = `[Berita: ${n.title}] `;
  document.getElementById('postType').value = 'news';
  window.scrollTo({top: document.querySelector('.post-row').offsetTop - 40, behavior: 'smooth'});
};
window.toggleNewsLike = toggleNewsLike;
window.toggleNewsDislike = toggleNewsDislike;
window.postNewsComment = postNewsComment;
window.toggleForumLike = toggleForumLike;
window.openReplies = openReplies;
window.deleteForumPost = deleteForumPost;
window.sendReply = sendReply;

</script>
</body>
</html>
